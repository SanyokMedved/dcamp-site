version: 2

jobs:
  build:
    # Override CIRCLE_WORKING_DIRECTORY (set to ~/project by default)
    working_directory: /home/agent/build
    docker:
      - image: docksal/ci-agent:php
    steps:
      # Inject build environment variables.
      # Each run statement runs in its own isolated shell (exported variables are not preserved).
      # $BASH_ENV can be used to pass environment variables between run statements.
      - run:
          name: Configure agent environment
          command: echo 'source build-env' > $BASH_ENV
      # Code checkout in the build agent
      - checkout
      - restore_cache:
          keys:
          - composer-{{ checksum "/home/agent/build/.composer/composer.json" }}
      # Launch a sandbox on the sandbox server
      - run:
          name: Build sandbox
          command: sandbox-init
      # Run other commands
      - run:
          name: Other commands
          command: |
            DEBUG=1 source build-env
            build-exec 'fin drush status'
      - save_cache:
          key: composer-{{ checksum "/home/agent/build/.composer/composer.json" }}
          paths:
          - /home/agent/build/.composer/
      - persist_to_workspace:
          root: /home/agent/build
          paths:
          - .composer
          - agent

workflows:
  version: 2
  default-workflow:
    jobs:
      - build
